function [f1,f2,S] = ESPRIT_2D(X,M,N,K)
% L = size(X,2);
% R = X*X'/L;
% [V,D] = eig(R);
% [di,inds] = sort(diag(D),'descend');
[Es,~,~] = svds(X,K);
% Es = Uni_ss_est(X,K);
J1 = kron(eye(N),[eye(M-1),zeros(M-1,1)]);
J2 = kron(eye(N),[zeros(M-1,1),eye(M-1)]);
Psi = (J1*Es)\(J2*Es);
[T,D] = eig(Psi);
f1 = angle(diag(D))/2/pi;
% [f1,inds] = sort(f1);
% Te = rowPermutateMat(M,N);
A = Es*T;%(:,inds);
J3 = kron([eye(N-1),zeros(N-1,1)],eye(M));
J4 = kron([zeros(N-1,1),eye(N-1)],eye(M));
Phi = (J3*A)\(J4*A);
f2 = angle(diag(Phi))/2/pi;
A1 = exp(1i*2*pi*(0:(M-1)).'*f1.');
A2 = exp(1i*2*pi*(0:(N-1)).'*f2.');
A = kr(A2,A1);
S = mean(abs((A'*A)\A'*X),2);