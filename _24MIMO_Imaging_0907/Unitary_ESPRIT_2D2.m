function [f1,f2,S] = Unitary_ESPRIT_2D2(X,M,N,K)
% L = size(X,2);
% Z = [X IEM(M*N)*conj(X)*IEM(L)];
% QMN = UniMat(M*N);
% Q2L = UniMat(L*2);
% Zc = real(QMN'*Z*Q2L);
Z1 = X(1:(M*N)/2,:);
Z2 = X((M*N)/2+1:end,:);
T1 = real(Z1+IEM((M*N)/2)*Z2);
T2 = -imag(Z1+IEM((M*N)/2)*Z2);
T3 = imag(Z1-IEM((M*N)/2)*Z2);
T4 = real(Z1-IEM((M*N)/2)*Z2);
Zc = [T1 T2;
    T3 T4];
[U,D,V] = svd(Zc);
Uz = U(:,1:K);
% J1 = [eye(M-1) zeros(M-1,1)];
J2 = kron(eye(N),[zeros(M-1,1) eye(M-1)]);
tmp = (UniMat((M-1)*N))'*J2*UniMat(M*N);
% K1 = kron(eye(N),real(tmp));
% K2 = kron(eye(N),imag(tmp));
% tmp = kron(eye(N),(UniMat(M-1))'*J2*UniMat(M));
E1 = real(tmp)*Uz;
E2 = imag(tmp)*Uz;
Psi1 = pinv(E1)*E2;
clear tmp;clear E1;clear E2;
% J3 = [eye(N-1) zeros(N-1,1)];
% J4 = kron([zeros(N-1,1) eye(N-1)],eye(M));
% tmp0 = (UniMat(M*(N-1)))'*J4*UniMat(M*N);
J4 = kron([zeros(N-1,1) eye(N-1)],eye(M));
tmp = (UniMat((N-1)*M))'*J4*UniMat(M*N);
% K3 = kron(real(tmp),eye(M));
% K4 = kron(imag(tmp),eye(M));
% imag(tmp0+tmp)
E1 = real(tmp)*Uz;
E2 = imag(tmp)*Uz;
Psi2 = pinv(E1)*E2;
[T,D] = eig(Psi1+1i*Psi2);
f1 = atan(diag(real(D)))/pi;
f2 = atan(diag(imag(D)))/pi;
A1 = exp(1i*2*pi*(0:(M-1)).'*f1.');
A2 = exp(1i*2*pi*(0:(N-1)).'*f2.');
A = kr(A2,A1);
S = mean(abs((A'*A)\A'*X),2);
