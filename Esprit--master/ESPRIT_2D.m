function [f1,f2,S] = ESPRIT_2D(X,M,N,K)
L = size(X,2);
R = X*X'/L;
[V,D] = eig(R);
[di,inds] = sort(diag(D),'descend');
Es = V(:,inds(1:K));
E1 = Es(1:end-M,:);
E2 = Es(M+1:end,:);
Psi = inv(E1'*E1)*E1'*E2;
[T,D] = eig(Psi);
f2 = angle(diag(D))/2/pi;
% Te = rowPermutateMat(M,N);
J1 = kron(eye(N),[eye(M-1) zeros(M-1,1)]);
J2 = kron(eye(N),[zeros(M-1,1) eye(M-1)]);
% Es2 = Te*Es;
B = Es*T;
B1 = J1*B;
B2 = J2*B;
Phi = B1\B2;
f1 = angle(diag(Phi))/2/pi;
A1 = exp(1i*2*pi*(0:(M-1)).'*f1.');
A2 = exp(1i*2*pi*(0:(N-1)).'*f2.');
A = kr(A2,A1);
S = mean(abs((A'*A)\A'*X),2);